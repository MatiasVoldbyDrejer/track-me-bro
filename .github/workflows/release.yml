name: Release to Chrome Web Store

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Validate manifest version matches tag
        run: |
          MANIFEST_VERSION=$(jq -r .version manifest.json)
          if [ "$MANIFEST_VERSION" != "${{ steps.version.outputs.VERSION }}" ]; then
            echo "::error::manifest.json version ($MANIFEST_VERSION) does not match tag (${{ steps.version.outputs.VERSION }})"
            exit 1
          fi

      - name: Package extension
        run: |
          zip -j9 track-me-bro.zip manifest.json
          zip -r9 track-me-bro.zip \
            src/background.js \
            src/content.js \
            src/quips.js \
            src/popup/popup.html \
            src/popup/popup.js \
            src/popup/popup.css \
            icons/icon-16.png \
            icons/icon-32.png \
            icons/icon-48.png \
            icons/icon-128.png

      - name: Upload to Chrome Web Store
        run: |
          # Get access token from refresh token
          ACCESS_TOKEN=$(curl -s -X POST "https://oauth2.googleapis.com/token" \
            -d "client_id=${{ secrets.CHROME_CLIENT_ID }}" \
            -d "client_secret=${{ secrets.CHROME_CLIENT_SECRET }}" \
            -d "refresh_token=${{ secrets.CHROME_REFRESH_TOKEN }}" \
            -d "grant_type=refresh_token" | jq -r .access_token)

          if [ "$ACCESS_TOKEN" = "null" ] || [ -z "$ACCESS_TOKEN" ]; then
            echo "::error::Failed to obtain access token"
            exit 1
          fi

          # Upload zip
          UPLOAD_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X PUT \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "x-goog-api-version: 2" \
            -T track-me-bro.zip \
            "https://www.googleapis.com/upload/chromewebstore/v1.1/items/${{ secrets.CHROME_EXTENSION_ID }}")

          HTTP_CODE=$(echo "$UPLOAD_RESPONSE" | tail -1)
          BODY=$(echo "$UPLOAD_RESPONSE" | sed '$d')

          echo "Upload response ($HTTP_CODE): $BODY"
          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "::error::Upload failed with HTTP $HTTP_CODE"
            exit 1
          fi

          # Publish
          PUBLISH_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "x-goog-api-version: 2" \
            -H "Content-Length: 0" \
            "https://www.googleapis.com/chromewebstore/v1.1/items/${{ secrets.CHROME_EXTENSION_ID }}/publish")

          HTTP_CODE=$(echo "$PUBLISH_RESPONSE" | tail -1)
          BODY=$(echo "$PUBLISH_RESPONSE" | sed '$d')

          echo "Publish response ($HTTP_CODE): $BODY"
          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "::error::Publish failed with HTTP $HTTP_CODE"
            exit 1
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: track-me-bro.zip
          generate_release_notes: true
